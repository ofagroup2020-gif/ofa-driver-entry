/* =========================
   OFA Driver App - app.js
   (このHTML専用の完全版)
========================= */

// ▼OFAメンバーシップLINE（ここはあなたのURLに固定）
const LINE_MEMBERSHIP_URL = "https://lin.ee/Ev7r84H5";

// ▼日本語PDFを確実にするならAPI推奨（Render等）
// 例: https://xxxxx.onrender.com/api/pdf
// 未設定でも動くが、jsPDF単体だと日本語が文字化けしやすい
const API_PDF_URL = ""; // ←使うならここに入れる

document.addEventListener("DOMContentLoaded", () => {
  const steps = Array.from(document.querySelectorAll(".step"));
  const nextBtn = document.getElementById("nextBtn");
  const backBtn = document.getElementById("backBtn");
  const barFill = document.getElementById("barFill");
  const stepLabel = document.getElementById("stepLabel");
  const toastEl = document.getElementById("toast");
  const dots = Array.from(document.querySelectorAll(".dots .d"));

  const makePdfBtn = document.getElementById("makePdfBtn");
  const lineLinkBtn = document.getElementById("lineLinkBtn");

  // 画像アップロード
  const licFrontInput = document.getElementById("licFront");
  const licBackInput = document.getElementById("licBack");
  const licFrontPrev = document.getElementById("licFrontPrev");
  const licBackPrev = document.getElementById("licBackPrev");

  // 所属区分ボタン
  const segBtns = Array.from(document.querySelectorAll(".segBtn"));
  const affTypeHidden = document.getElementById("affType");

  // 規約同意
  const agree = document.getElementById("agree");

  // state
  let current = 1;
  let licFrontFile = null;
  let licBackFile = null;

  /* ---------- util ---------- */
  const $v = (id) => (document.getElementById(id)?.value || "").trim();

  function showToast(msg) {
    if (!toastEl) return alert(msg);
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1600);
  }

  function setStep(n) {
    current = Math.min(Math.max(1, n), steps.length);

    steps.forEach((s) => s.classList.toggle("active", Number(s.dataset.step) === current));

    // progress
    const pct = ((current - 1) / (steps.length - 1)) * 100;
    if (barFill) barFill.style.width = `${pct}%`;
    if (stepLabel) stepLabel.textContent = `STEP ${current} / ${steps.length}`;

    // dots
    if (dots.length) {
      dots.forEach((d, i) => {
        d.classList.toggle("on", i === current - 1);
      });
    }

    // nav
    if (backBtn) backBtn.disabled = current === 1;
    if (nextBtn) {
      nextBtn.style.display = current === steps.length ? "none" : "inline-flex";
    }
  }

  function normalizeBirth(v) {
    // date inputは YYYY-MM-DD
    if (!v) return "";
    if (v.includes("/")) {
      const [y, m, d] = v.split("/");
      if (y && m && d) return `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
    }
    return v;
  }

  function validateStep(stepNo) {
    // 必須最小セット（止まる原因を確実に判定）
    if (stepNo === 1) {
      const birth = normalizeBirth($v("birth"));
      if (!$v("name") || !$v("kana") || !$v("phone") || !$v("email") || !birth) {
        return "STEP1：未入力があります（特に生年月日）";
      }
    }
    if (stepNo === 2) {
      if (!$v("zip") || !$v("pref") || !$v("city") || !$v("addr1")) {
        return "STEP2：住所を入力してください";
      }
    }
    if (stepNo === 3) {
      if (!$v("affType")) return "STEP3：所属区分を選択してください";
    }
    if (stepNo === 4) {
      if (!$v("vehicleType") || !$v("plate") || !$v("blackPlate")) {
        return "STEP4：車両情報を入力してください";
      }
    }
    if (stepNo === 5) {
      if (!licFrontFile) return "STEP5：免許証（表面）は必須です";
    }
    if (stepNo === 6) {
      if (!$v("bank") || !$v("branch") || !$v("acctType") || !$v("acctNo") || !$v("acctName")) {
        return "STEP6：振込先情報を入力してください";
      }
    }
    if (stepNo === 7) {
      if (!agree?.checked) return "規約に同意してください";
    }
    return "";
  }

  function collectData() {
    return {
      name: $v("name"),
      kana: $v("kana"),
      phone: $v("phone"),
      email: $v("email"),
      birth: normalizeBirth($v("birth")),
      zip: $v("zip"),
      pref: $v("pref"),
      city: $v("city"),
      addr1: $v("addr1"),
      addr2: $v("addr2"),
      affType: $v("affType"),
      company: $v("company"),
      vehicleType: $v("vehicleType"),
      plate: $v("plate"),
      blackPlate: $v("blackPlate"),
      bank: $v("bank"),
      branch: $v("branch"),
      acctType: $v("acctType"),
      acctNo: $v("acctNo"),
      acctName: $v("acctName"),
    };
  }

  /* ---------- handlers ---------- */
  nextBtn?.addEventListener("click", () => {
    const msg = validateStep(current);
    if (msg) return showToast(msg);
    setStep(current + 1);
  });

  backBtn?.addEventListener("click", () => {
    setStep(current - 1);
  });

  // 所属区分
  segBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      segBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      if (affTypeHidden) affTypeHidden.value = btn.dataset.value || "";
    });
  });

  // 免許プレビュー
  function previewFile(file, imgEl) {
    if (!file || !imgEl) return;
    const url = URL.createObjectURL(file);
    imgEl.src = url;
    imgEl.style.display = "block";
    imgEl.onload = () => URL.revokeObjectURL(url);
  }

  licFrontInput?.addEventListener("change", (e) => {
    licFrontFile = e.target.files?.[0] || null;
    previewFile(licFrontFile, licFrontPrev);
  });

  licBackInput?.addEventListener("change", (e) => {
    licBackFile = e.target.files?.[0] || null;
    previewFile(licBackFile, licBackPrev);
  });

  // LINEリンク
  if (lineLinkBtn) lineLinkBtn.href = LINE_MEMBERSHIP_URL;

  /* ---------- PDF ---------- */
  async function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1500);
  }

  async function makePdfViaApi() {
    if (!API_PDF_URL) {
      showToast("PDF APIが未設定です（API_PDF_URLを設定してください）");
      return;
    }

    // 1〜7全部チェック
    for (let i = 1; i <= 7; i++) {
      const msg = validateStep(i);
      if (msg) {
        setStep(i);
        showToast(msg);
        return;
      }
    }

    showToast("PDF作成中…");

    const data = collectData();
    const fd = new FormData();
    fd.append("data", JSON.stringify(data));
    fd.append("licFront", licFrontFile);
    if (licBackFile) fd.append("licBack", licBackFile);

    const res = await fetch(API_PDF_URL, { method: "POST", body: fd });
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      console.error(text);
      showToast("PDF作成失敗（API/フォント設定を確認）");
      return;
    }

    const blob = await res.blob();
    const ymd = new Date().toISOString().slice(0, 10);
    await downloadBlob(blob, `OFA_登録_${data.name || "driver"}_${ymd}.pdf`);
    showToast("PDFを保存しました。LINEへ送信してください");
  }

  // jsPDF単体は日本語が文字化けしやすいので「最終手段」扱い
  async function makePdfFallbackJsPdf() {
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) return showToast("jsPDFが読み込めていません");

    // 1〜7全部チェック
    for (let i = 1; i <= 7; i++) {
      const msg = validateStep(i);
      if (msg) {
        setStep(i);
        showToast(msg);
        return;
      }
    }

    showToast("PDF作成中…（日本語が文字化けする可能性あり）");

    const data = collectData();
    const doc = new jsPDF({ unit: "pt", format: "a4" });

    // ※日本語フォント未埋め込みだと文字化けします
    doc.setFont("helvetica", "normal");
    doc.setFontSize(14);
    doc.text("OFA GROUP Driver Entry", 40, 50);

    doc.setFontSize(10);
    const lines = [
      `Name: ${data.name}`,
      `Kana: ${data.kana}`,
      `Phone: ${data.phone}`,
      `Email: ${data.email}`,
      `Birth: ${data.birth}`,
      `Address: ${data.zip} ${data.pref}${data.city}${data.addr1} ${data.addr2}`,
      `Affiliation: ${data.affType} / ${data.company}`,
      `Vehicle: ${data.vehicleType} / ${data.plate} / ${data.blackPlate}`,
      `Bank: ${data.bank} ${data.branch} ${data.acctType} ${data.acctNo} ${data.acctName}`,
    ];

    let y = 80;
    lines.forEach((t) => {
      doc.text(t, 40, y);
      y += 14;
    });

    doc.save("OFA_Entry.pdf");
    showToast("PDFを保存しました。LINEへ送信してください");
  }

  makePdfBtn?.addEventListener("click", async () => {
    // APIがあるならAPI優先（日本語100%）
    if (API_PDF_URL) return makePdfViaApi();
    return makePdfFallbackJsPdf();
  });

  // 初期表示
  setStep(1);
});
