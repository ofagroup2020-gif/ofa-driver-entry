// ====== 設定：あなたのAPI URLに置換 ======
const API_URL = "https://YOUR-RENDER-URL/api/submit";
// =========================================

const steps = [...document.querySelectorAll(".step")];
const barFill = document.getElementById("barFill");
const stepText = document.getElementById("stepText");
const nextBtn = document.getElementById("nextBtn");
const backBtn = document.getElementById("backBtn");
const submitBtn = document.getElementById("submitBtn");
const toast = document.getElementById("toast");
const reviewEl = document.getElementById("review");

let current = 1;

let licFrontFile = null;
let licBackFile = null;

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1700);
}
function setStep(n){
  current = n;
  steps.forEach(s => s.classList.toggle("active", Number(s.dataset.step) === current));
  const pct = ((current - 1) / (steps.length - 1)) * 100;
  barFill.style.width = `${pct}%`;
  stepText.textContent = `STEP ${current} / ${steps.length}`;

  backBtn.style.visibility = current === 1 ? "hidden" : "visible";
  nextBtn.style.display = current === steps.length ? "none" : "inline-block";
  document.querySelector(".nav").style.display = current === steps.length ? "none" : "flex";

  if(current === steps.length) renderReview();
}
function val(id){ return document.getElementById(id).value?.trim() || ""; }

function validateStep(n){
  if(n===1){
    if(!val("name") || !val("kana") || !val("phone") || !val("email") || !val("birth")) return "基本情報を入力してください";
  }
  if(n===2){
    if(!val("zip") || !val("pref") || !val("city") || !val("addr1")) return "住所を入力してください";
  }
  if(n===3){
    if(!val("affType")) return "所属区分を選択してください";
  }
  if(n===4){
    if(!val("vehicleType") || !val("plate") || !val("blackPlate")) return "車両情報を入力してください";
  }
  if(n===5){
    if(!licFrontFile) return "免許証（表面）をアップロードしてください";
  }
  if(n===6){
    if(!val("bank") || !val("branch") || !val("acctType") || !val("acctNo") || !val("acctName")) return "振込先を入力してください";
  }
  return "";
}

nextBtn.addEventListener("click", () => {
  const msg = validateStep(current);
  if(msg){ showToast(msg); return; }
  setStep(current + 1);
});
backBtn.addEventListener("click", () => setStep(Math.max(1, current - 1)));

// 所属区分
document.querySelectorAll(".segBtn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".segBtn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("affType").value = btn.dataset.value;
  });
});

// プレビュー
function setPreview(inputId, imgId, setFile){
  const input = document.getElementById(inputId);
  const img = document.getElementById(imgId);
  input.addEventListener("change", () => {
    const f = input.files?.[0];
    if(!f) return;
    setFile(f);
    img.src = URL.createObjectURL(f);
    img.classList.add("show");
  });
}
setPreview("licFront","licFrontPrev",(f)=> licFrontFile=f);
setPreview("licBack","licBackPrev",(f)=> licBackFile=f);

function collectData(){
  return {
    name: val("name"),
    kana: val("kana"),
    phone: val("phone"),
    email: val("email"),
    birth: val("birth"),

    zip: val("zip"),
    pref: val("pref"),
    city: val("city"),
    addr1: val("addr1"),
    addr2: val("addr2"),

    affType: val("affType"),
    company: val("company"),

    vehicleType: val("vehicleType"),
    plate: val("plate"),
    blackPlate: val("blackPlate"),

    bank: val("bank"),
    branch: val("branch"),
    acctType: val("acctType"),
    acctNo: val("acctNo"),
    acctName: val("acctName"),
  };
}

function renderReview(){
  const d = collectData();
  reviewEl.innerHTML = `
    <div><strong>氏名</strong>${d.name}（${d.kana}）</div>
    <div><strong>電話</strong>${d.phone}</div>
    <div><strong>メール</strong>${d.email}</div>
    <div><strong>生年月日</strong>${d.birth}</div>
    <hr/>
    <div><strong>住所</strong>${d.zip} ${d.pref}${d.city}${d.addr1} ${d.addr2}</div>
    <hr/>
    <div><strong>所属</strong>${d.affType}</div>
    <div><strong>会社</strong>${d.company || "—"}</div>
    <hr/>
    <div><strong>車両</strong>${d.vehicleType} / ${d.plate} / 黒:${d.blackPlate}</div>
    <hr/>
    <div><strong>振込</strong>${d.bank} ${d.branch} / ${d.acctType} ${d.acctNo}</div>
    <div><strong>名義</strong>${d.acctName}</div>
  `;
}

submitBtn.addEventListener("click", async () => {
  // 全体チェック
  for(let i=1;i<=6;i++){
    const msg = validateStep(i);
    if(msg){ showToast(msg); setStep(i); return; }
  }

  try{
    submitBtn.disabled = true;
    submitBtn.textContent = "送信中...";

    const data = collectData();
    const fd = new FormData();
    fd.append("data", JSON.stringify(data));
    fd.append("licFront", licFrontFile);
    if(licBackFile) fd.append("licBack", licBackFile);

    const res = await fetch(API_URL, { method:"POST", body: fd });
    const json = await res.json();
    if(!json.ok) throw new Error(json.message || "送信に失敗しました");

    submitBtn.textContent = "完了しました";
    alert("登録完了！OFA管理に自動送信しました。\nPDF: " + json.url);
  }catch(e){
    console.error(e);
    alert("エラー: " + (e?.message || e));
    submitBtn.disabled = false;
    submitBtn.textContent = "登録完了 → PDF作成 → LINE自動送信";
  }
});

setStep(1);
